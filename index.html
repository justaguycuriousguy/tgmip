<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Stogie Meme Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/telegram-web-app/6.7.0/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu;
            margin: 0;
            padding: 16px;
            background-color: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            margin-bottom: 16px;
            overflow: hidden;
            border-radius: 8px;
            touch-action: none;
        }

        #baseImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .stogie {
            position: absolute;
            cursor: move;
            touch-action: none;
            left: 50%;
            top: 50%;
            transform-origin: center;
        }

        .control-panel {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .button {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .slider-container {
            margin: 12px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            color: var(--tg-theme-hint-color, #999);
        }

        input[type="range"] {
            width: 100%;
            height: 36px;
        }

        .stogie-selector {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px;
            margin-bottom: 16px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .stogie-option {
            width: 60px;
            height: 60px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px;
            background: white;
        }

        .stogie-option.selected {
            border-color: var(--tg-theme-button-color, #2481cc);
        }

        .stogie-option img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #fileInput {
            display: none;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Main app container -->
    <div class="canvas-container" id="canvasContainer">
        <img id="baseImage" alt="Base image">
    </div>

    <!-- Stogie selector -->
    <div class="stogie-selector" id="stogieSelector">
        <!-- We'll populate this with SVG stogies -->
    </div>

    <!-- Controls -->
    <div class="control-panel">
        <input type="file" id="fileInput" accept="image/*">
        <button class="button" id="uploadButton">Choose Image</button>
        
        <div class="slider-container">
            <label>Rotation</label>
            <input type="range" id="rotationSlider" min="0" max="360" value="0">
        </div>

        <div class="slider-container">
            <label>Size</label>
            <input type="range" id="scaleSlider" min="50" max="200" value="100">
        </div>

        <button class="button" id="saveButton">Save Meme</button>
    </div>

    <script>
        // Initialize Telegram WebApp
        const webapp = window.Telegram.WebApp;
        webapp.ready();
        webapp.expand();

        // Stogie SVG definitions
        const stogies = [
            {
                id: 'classic',
                svg: `<svg viewBox="0 0 100 20" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="5" width="80" height="10" fill="#8B4513"/>
                    <circle cx="80" cy="10" r="5" fill="#D2691E"/>
                    <rect x="80" y="5" width="20" height="10" fill="#A0522D"/>
                </svg>`
            },
            {
                id: 'cuban',
                svg: `<svg viewBox="0 0 100 20" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="5" width="90" height="10" fill="#654321"/>
                    <circle cx="90" cy="10" r="5" fill="#8B4513"/>
                    <rect x="90" y="5" width="10" height="10" fill="#A0522D"/>
                </svg>`
            },
            {
                id: 'modern',
                svg: `<svg viewBox="0 0 100 20" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="2" width="85" height="16" rx="2" fill="#6B4423"/>
                    <circle cx="85" cy="10" r="8" fill="#8B4513"/>
                    <rect x="85" y="2" width="15" height="16" rx="2" fill="#A0522D"/>
                </svg>`
            }
        ];

        let activeStogieId = null;
        let activeElement = null;

        // Initialize stogie selector
        const selectorContainer = document.getElementById('stogieSelector');
        stogies.forEach(stogie => {
            const option = document.createElement('div');
            option.className = 'stogie-option';
            option.innerHTML = stogie.svg;
            option.onclick = () => selectStogie(stogie.id);
            selectorContainer.appendChild(option);
        });

        function selectStogie(id) {
            // Remove existing stogie if any
            if (activeElement) {
                activeElement.remove();
            }

            // Create new stogie
            activeStogieId = id;
            const stogie = stogies.find(s => s.id === id);
            const stogieElement = document.createElement('div');
            stogieElement.className = 'stogie';
            stogieElement.innerHTML = stogie.svg;
            document.getElementById('canvasContainer').appendChild(stogieElement);
            activeElement = stogieElement;

            // Update selector UI
            document.querySelectorAll('.stogie-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Initialize dragging for new element
            setupDragging(stogieElement);
            updateTransform();
        }

        // Select first stogie by default
        selectStogie(stogies[0].id);

        // File handling
        const fileInput = document.getElementById('fileInput');
        document.getElementById('uploadButton').onclick = () => {
            webapp.showPopup({
                title: 'Upload Image',
                message: 'Choose image source',
                buttons: [
                    {id: 'camera', type: 'default', text: 'Camera'},
                    {id: 'gallery', type: 'default', text: 'Gallery'}
                ]
            }, (buttonId) => {
                if (buttonId) {
                    fileInput.click();
                }
            });
        };

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('baseImage').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        // Dragging functionality
        let isDragging = false;
        let currentX = 0;
        let currentY = 0;
        let initialX = 0;
        let initialY = 0;
        let xOffset = 50;
        let yOffset = 50;

        function setupDragging(element) {
            element.onmousedown = dragStart;
            element.ontouchstart = dragStart;
            document.onmouseup = dragEnd;
            document.ontouchend = dragEnd;
            document.onmousemove = drag;
            document.ontouchmove = drag;
        }

        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            isDragging = true;
        }

        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }

        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                updateTransform();
            }
        }

        // Transform updates
        function updateTransform() {
            if (activeElement) {
                const rotation = document.getElementById('rotationSlider').value;
                const scale = document.getElementById('scaleSlider').value / 100;
                activeElement.style.transform = 
                    `translate(${xOffset}px, ${yOffset}px) rotate(${rotation}deg) scale(${scale})`;
            }
        }

        // Add transform event listeners
        document.getElementById('rotationSlider').addEventListener('input', updateTransform);
        document.getElementById('scaleSlider').addEventListener('input', updateTransform);

        // Save functionality
        document.getElementById('saveButton').addEventListener('click', async () => {
            try {
                // Create canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const container = document.getElementById('canvasContainer');
                
                // Set canvas size
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;

                // Draw base image
                const baseImage = document.getElementById('baseImage');
                if (baseImage.src) {
                    ctx.drawImage(baseImage, 0, 0, canvas.width, canvas.height);
                }

                // Draw stogie
                if (activeElement) {
                    // Convert SVG to image
                    const svgData = new XMLSerializer().serializeToString(activeElement.querySelector('svg'));
                    const img = new Image();
                    img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
                    
                    await new Promise((resolve) => {
                        img.onload = resolve;
                    });

                    // Get transformation values
                    const transform = activeElement.style.transform;
                    const rotation = document.getElementById('rotationSlider').value;
                    const scale = document.getElementById('scaleSlider').value / 100;

                    // Apply transformations
                    ctx.save();
                    ctx.translate(xOffset + img.width/2, yOffset + img.height/2);
                    ctx.rotate(rotation * Math.PI / 180);
                    ctx.scale(scale, scale);
                    ctx.drawImage(img, -img.width/2, -img.height/2);
                    ctx.restore();
                }

                // Convert to blob and share
                canvas.toBlob((blob) => {
                    // Create shareable file
                    const file = new File([blob], "meme.png", { type: "image/png" });
                    
                    // Share via Telegram
                    webapp.showPopup({
                        title: 'Meme Saved!',
                        message: 'Your meme has been created successfully!',
                        buttons: [
                            {id: 'share', type: 'default', text: 'Share'},
                            {id: 'close', type: 'cancel', text: 'Close'}
                        ]
                    }, (buttonId) => {
                        if (buttonId === 'share') {
                            // In a real app, you'd use Telegram's sharing functionality here
                            webapp.showAlert("Sharing functionality would be implemented here!");
                        }
                    });
                });

            } catch (error) {
                webapp.showAlert('Error saving meme: ' + error.message);
            }
        });

    </script>
</body>
</html>

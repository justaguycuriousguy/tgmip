<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vaporwave Meme Maker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/telegram-web-app/6.7.0/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --neon-pink: #ff71ce;
            --neon-blue: #01cdfe;
            --neon-purple: #b967ff;
            --neon-green: #05ffa1;
            --dark-bg: #1a1a2e;
            --grid-color: rgba(255, 113, 206, 0.1);
            --retrowave-gradient: linear-gradient(
                45deg,
                var(--neon-pink),
                var(--neon-purple),
                var(--neon-blue)
            );
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
            margin: 0;
            padding: 16px;
            background-color: var(--dark-bg);
            background-image: 
                linear-gradient(var(--grid-color) 2px, transparent 2px),
                linear-gradient(90deg, var(--grid-color) 2px, transparent 2px);
            background-size: 40px 40px;
            color: white;
            min-height: 100vh;
            touch-action: manipulation;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: calc(100vw * 0.75);
            max-height: 400px;
            background: rgba(0, 0, 0, 0.5);
            margin-bottom: 8px;
            border-radius: 12px;
            touch-action: none;
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 15px var(--neon-blue);
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            backdrop-filter: blur(5px);
        }

        #baseImage {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            pointer-events: none;
        }

        .stogie-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--neon-pink);
            border-radius: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 0 10px var(--neon-pink);
            backdrop-filter: blur(5px);
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .stogie-selector::-webkit-scrollbar {
            display: none;
        }

        .stogie-option {
            flex: 0 0 80px;
            height: 50px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--neon-purple);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 5px;
        }

        .stogie-option:active {
            transform: scale(0.95);
            box-shadow: 0 0 15px var(--neon-purple);
        }

        .stogie-option img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid var(--neon-green);
            box-shadow: 0 0 10px var(--neon-green);
            backdrop-filter: blur(5px);
        }

        .button {
            background: var(--retrowave-gradient);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            -webkit-tap-highlight-color: transparent;
        }

        .button:active {
            transform: scale(0.98);
            box-shadow: 0 0 20px var(--neon-purple);
        }

        .delete-button {
            background: linear-gradient(45deg, #ff0844, #ffb199);
        }

        .delete-button.disabled {
            background: #333;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .slider-container {
            margin: 12px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            color: var(--neon-pink);
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 1px;
        }

        input[type="range"] {
            width: 100%;
            height: 36px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            outline: none;
            border: 1px solid var(--neon-blue);
            margin: 0;
            padding: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: var(--neon-purple);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px var(--neon-purple);
            border: none;
            margin-top: -8px;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            border: none;
        }

        .upload-area {
            text-align: center;
            padding: 40px;
            color: var(--neon-blue);
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .overlay-image {
            position: absolute;
            width: 150px;
            height: auto;
            cursor: move;
            touch-action: none;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            user-select: none;
            -webkit-user-select: none;
            pointer-events: all;
            transform-origin: center;
            transition: outline-color 0.3s ease;
            will-change: transform;
        }

        .overlay-image.selected {
            outline: 2px solid var(--neon-pink);
            outline-offset: 2px;
            box-shadow: 0 0 15px var(--neon-pink);
        }

        #fileInput {
            display: none;
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            .canvas-container {
                height: calc(100vw * 0.8);
            }

            .button {
                padding: 15px 20px;
                font-size: 14px;
            }

            .overlay-image {
                width: 120px;
            }

            .upload-area {
                font-size: 16px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="canvas-container" id="canvasContainer">
        <div class="upload-area" id="uploadArea">
            Click "Choose Image" to start
        </div>
        <img id="baseImage" style="display: none;">
    </div>

    <div class="stogie-selector" id="stogieSelector">
        <div class="stogie-option">
            <img src="images/stogie.png" alt="Stogie 1" data-type="overlay">
        </div>
        <div class="stogie-option">
            <img src="images/stogie2.png" alt="Stogie 2" data-type="overlay">
        </div>
        <div class="stogie-option">
            <img src="images/stogie3.png" alt="Stogie 3" data-type="overlay">
        </div>
        <div class="stogie-option">
            <img src="images/glasses.png" alt="Glasses" data-type="overlay">
        </div>
    </div>

    <div class="control-panel">
        <input type="file" id="fileInput" accept="image/*">
        <button class="button" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-image"></i> Choose Image
        </button>
        
        <div class="slider-container">
            <label>Rotation</label>
            <input type="range" id="rotationSlider" min="0" max="360" value="0">
        </div>

        <div class="slider-container">
            <label>Size</label>
            <input type="range" id="scaleSlider" min="50" max="200" value="100">
        </div>

        <button class="button delete-button disabled" id="deleteButton">
            <i class="fas fa-trash"></i> Delete Selected
        </button>

        <button class="button" id="saveButton">
            <i class="fas fa-save"></i> Save Meme
        </button>
    </div>

    <script>
        const container = document.getElementById('canvasContainer');
        const rotationSlider = document.getElementById('rotationSlider');
        const scaleSlider = document.getElementById('scaleSlider');
        const fileInput = document.getElementById('fileInput');
        const baseImage = document.getElementById('baseImage');
        const uploadArea = document.getElementById('uploadArea');
        const deleteButton = document.getElementById('deleteButton');
        
        let activeOverlay = null;
        let overlays = [];
        let isDragging = false;
        let currentX = 0;
        let currentY = 0;
        let initialX = 0;
        let initialY = 0;

        function createOverlay(source) {
            const overlay = document.createElement('img');
            overlay.src = source;
            overlay.className = 'overlay-image';
            overlay.dataset.x = 0;
            overlay.dataset.y = 0;
            overlay.dataset.rotation = 0;
            overlay.dataset.scale = 1;
            
            container.appendChild(overlay);
            overlays.push(overlay);
            
            overlay.addEventListener('mousedown', handleStart);
            overlay.addEventListener('touchstart', handleStart);
            
            return overlay;
        }

        function handleStart(e) {
            const overlay = e.target;
            selectOverlay(overlay);
            dragStart(e);
        }

        function selectOverlay(overlay) {
            overlays.forEach(o => o.classList.remove('selected'));
            overlay.classList.add('selected');
            activeOverlay = overlay;
            deleteButton.classList.remove('disabled');
            rotationSlider.value = overlay.dataset.rotation || 0;
            scaleSlider.value = (overlay.dataset.scale || 1) * 100;
        }

        document.querySelectorAll('.stogie-option').forEach(option => {
            option.addEventListener('click', () => {
                const img = option.querySelector('img');
                if (img) {
                    const overlay = createOverlay(img.src);
                    selectOverlay(overlay);
                }
            });
        });

        deleteButton.addEventListener('click', () => {
            if (activeOverlay) {
                container.removeChild(activeOverlay);
                overlays = overlays.filter(o => o !== activeOverlay);
                activeOverlay = null;
                deleteButton.classList.add('disabled');
            }
        });

        function dragStart(e) {
            if (!activeOverlay) return;
            
            isDragging = true;
            
            if (e.type === "touchstart") {
                const touch = e.touches[0];
                initialX = touch.clientX - (parseFloat(activeOverlay.dataset.x) || 0);
                initialY = touch.clientY - (parseFloat(activeOverlay.dataset.y) || 0);
            } else {
                initialX = e.clientX - (parseFloat(activeOverlay.dataset.x) || 0);
                initialY = e.clientY - (parseFloat(activeOverlay.dataset.y) || 0);
            }

            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !activeOverlay) return;
            
            e.preventDefault();
            
            let clientX, clientY;
            
            if (e.type === "touchmove") {
                const touch = e.touches[0];
                clientX = touch.clientX;
                clientY = touch.clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const rect = container.getBoundingClientRect();
            const x = clientX - initialX - rect.left;
            const y = clientY - initialY - rect.top;
            
            activeOverlay.dataset.x = x;
            activeOverlay.dataset.y = y;
            updateOverlayPosition(activeOverlay);
        }

        function dragEnd() {
            isDragging = false;
        }

        function updateOverlayPosition(overlay) {
            if (!overlay) return;
            
            const rotation = overlay.dataset.rotation || 0;
            const scale = overlay.dataset.scale || 1;
            const x = overlay.dataset.x || 0;
            const y = overlay.dataset.y || 0;
            
            overlay.style.transform = 
                `translate(${x}px, ${y}px) 
                 rotate(${rotation}deg) 
                 scale(${scale})`;
        }

        // Event listeners for both mouse and touch
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, { passive: false });
        document.addEventListener('mouseup', dragEnd);
        document.addEventListener('touchend', dragEnd);
        document.addEventListener('mouseleave', dragEnd);

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    baseImage.src = event.target.result;
                    baseImage.style.display = 'block';
                    uploadArea.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        rotationSlider.addEventListener('input', () => {
            if (activeOverlay) {
                activeOverlay.dataset.rotation = rotationSlider.value;
                updateOverlayPosition(activeOverlay);
            }
        });

        scaleSlider.addEventListener('input', () => {
            if (activeOverlay) {
                activeOverlay.dataset.scale = scaleSlider.value / 100;
                updateOverlayPosition(activeOverlay);
            }
        });

        document.getElementById('saveButton').addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            // Get the display dimensions of the container
            const containerRect = container.getBoundingClientRect();
            
            // Set canvas size to match display size
            tempCanvas.width = containerRect.width;
            tempCanvas.height = containerRect.height;

            // Draw base image maintaining aspect ratio
            if (baseImage.src) {
                const imgAspect = baseImage.naturalWidth / baseImage.naturalHeight;
                const containerAspect = containerRect.width / containerRect.height;
                let drawWidth = containerRect.width;
                let drawHeight = containerRect.height;
                let offsetX = 0;
                let offsetY = 0;

                if (containerAspect > imgAspect) {
                    drawWidth = drawHeight * imgAspect;
                    offsetX = (containerRect.width - drawWidth) / 2;
                } else {
                    drawHeight = drawWidth / imgAspect;
                    offsetY = (containerRect.height - drawHeight) / 2;
                }

                // Fill background
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Draw base image
                ctx.drawImage(baseImage, offsetX, offsetY, drawWidth, drawHeight);
            }

            // Draw overlays
            overlays.forEach(overlay => {
                const x = parseFloat(overlay.dataset.x) + overlay.width / 2;
                const y = parseFloat(overlay.dataset.y) + overlay.height / 2;
                const rotation = parseFloat(overlay.dataset.rotation) * Math.PI / 180;
                const scale = parseFloat(overlay.dataset.scale);

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(rotation);
                ctx.scale(scale, scale);
                ctx.drawImage(
                    overlay,
                    -overlay.width / 2,
                    -overlay.height / 2,
                    overlay.width,
                    overlay.height
                );
                ctx.restore();
            });

            // Create final canvas with higher resolution
            const finalCanvas = document.createElement('canvas');
            const finalCtx = finalCanvas.getContext('2d');
            const scaleFactor = 2; // Increase for higher quality

            finalCanvas.width = tempCanvas.width * scaleFactor;
            finalCanvas.height = tempCanvas.height * scaleFactor;
            
            finalCtx.drawImage(tempCanvas, 0, 0, finalCanvas.width, finalCanvas.height);

            finalCanvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'meme.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png', 1.0);
        });
    </script>
</body>
</html>
